<!DOCTYPE html>
<html>
<head>
    <title>–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç HLS</title>
    <script src="libs/hls.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: white; }
        video { width: 640px; height: 480px; background: #000; border: 2px solid #333; }
        .status { margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 5px; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 5px; margin: 5px; }
        button:hover { background: #5a67d8; }
    </style>
</head>
<body>
    <h1>üé• –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç HLS –ø–æ—Ç–æ–∫–∞</h1>
    <video id="video" controls></video>
    <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</div>
    
    <button onclick="testLocalStream()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫</button>
    <button onclick="stopStream()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫</button>
    
    <script>
        let currentStreamId = null;
        let hls = null;
        
        async function testLocalStream() {
            const status = document.getElementById('status');
            status.innerHTML = '‚è≥ –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞...';
            
            try {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
                const response = await fetch('http://localhost:3000/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        streamId: 'test_local_' + Date.now(),
                        rtspUrl: 'rtsp://185.70.184.101:8554/cam91-99',
                        quality: 'low'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentStreamId = data.streamId;
                    status.innerHTML = '<span class="success">‚úÖ –ü–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω!</span><br>Stream ID: ' + data.streamId;
                    
                    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                    setTimeout(() => {
                        const streamUrl = `/stream/${data.streamId}/playlist.m3u8`;
                        playHLS(streamUrl);
                    }, 5000);
                } else {
                    throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                status.innerHTML = '<span class="error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</span>';
            }
        }
        
        function playHLS(url) {
            const video = document.getElementById('video');
            const status = document.getElementById('status');
            
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                
                hls = new Hls({
                    debug: true,
                    liveSyncDurationCount: 3,
                    liveMaxLatencyDurationCount: 5
                });
                
                hls.loadSource(url);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    video.play();
                    status.innerHTML += '<br><span class="success">‚úÖ HLS –º–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!</span>';
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        status.innerHTML += '<br><span class="error">‚ùå HLS –æ—à–∏–±–∫–∞: ' + data.type + ' - ' + data.details + '</span>';
                    }
                });
            } else {
                status.innerHTML = '<span class="error">‚ùå HLS.js –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</span>';
            }
        }
        
        async function stopStream() {
            if (currentStreamId) {
                try {
                    await fetch('http://localhost:3000/api/stream/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ streamId: currentStreamId })
                    });
                    
                    document.getElementById('status').innerHTML = '‚èπÔ∏è –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    
                    if (hls) {
                        hls.destroy();
                        hls = null;
                    }
                    
                    currentStreamId = null;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
                }
            }
        }
    </script>
</body>
</html>
