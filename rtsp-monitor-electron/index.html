<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .current-info {
            color: white;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }

        .current-apartment {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .current-time {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
        }

        .user-info {
            color: white;
            text-align: right;
            font-size: 14px;
        }

        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã */
        .controls {
            background: rgba(0,0,0,0.2);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* –ö–Ω–æ–ø–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä */
        .apartment-buttons {
            padding: 15px 30px;
            display: flex;
            gap: 10px;
            justify-content: center;
            background: rgba(0,0,0,0.1);
        }

        .apartment-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .apartment-btn.active {
            background: #3498db;
            border-color: #3498db;
        }

        .apartment-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* –°–µ—Ç–∫–∞ –∫–∞–º–µ—Ä */
        .camera-grid {
            flex: 1;
            padding: 20px 30px;
            display: grid;
            gap: 15px;
            align-content: center;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */
        .camera-grid.cameras-1 { grid-template-columns: 1fr; max-width: 800px; margin: 0 auto; }
        .camera-grid.cameras-2 { grid-template-columns: 1fr 1fr; }
        .camera-grid.cameras-3 { grid-template-columns: 1fr 1fr 1fr; }
        .camera-grid.cameras-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .camera-grid.cameras-5, .camera-grid.cameras-6 { grid-template-columns: repeat(3, 1fr); }
        .camera-grid.cameras-7, .camera-grid.cameras-8, .camera-grid.cameras-9 { grid-template-columns: repeat(3, 1fr); }
        .camera-grid.cameras-10, .camera-grid.cameras-11, .camera-grid.cameras-12 { grid-template-columns: repeat(4, 1fr); }
        .camera-grid.cameras-13, .camera-grid.cameras-14, .camera-grid.cameras-15, .camera-grid.cameras-16 { grid-template-columns: repeat(4, 1fr); }

        /* –°–ª–æ—Ç –∫–∞–º–µ—Ä—ã */
        .camera-slot {
            position: relative;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .camera-slot:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .camera-slot.active {
            border-color: #27ae60;
        }

        .camera-slot.error {
            border-color: #e74c3c;
        }

        .camera-slot.loading {
            border-color: #f39c12;
        }

        /* –í–∏–¥–µ–æ –≤ —Å–ª–æ—Ç–µ */
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .camera-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.6);
        }

        .camera-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .camera-slot:hover .camera-overlay {
            transform: translateY(0);
        }

        .camera-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .camera-status {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–≤—É–∫–∞ */
        .audio-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .audio-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        .audio-btn.active {
            background: #27ae60;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ */
        .status-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #95a5a6;
        }

        .status-indicator.online {
            background: #27ae60;
        }

        .status-indicator.offline {
            background: #e74c3c;
        }

        .status-indicator.loading {
            background: #f39c12;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –∞–≤—Ç–æ—Ü–∏–∫–ª–∞ */
        .autocycle-controls {
            background: rgba(0,0,0,0.2);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: white;
            font-size: 14px;
        }

        .autocycle-controls select {
            padding: 5px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
        }

        .autocycle-controls select option {
            background: #333;
            color: white;
        }

        /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-video {
            position: relative;
            width: 90%;
            height: 90%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .fullscreen-video video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .fullscreen-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="logo">üé• –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</div>
            <div class="current-info">
                <div class="current-apartment" id="currentApartment">–¢–∞–π–ª–∞–Ω–¥ (–∫–≤–∞—Ä—Ç–∏—Ä–∞ 91)</div>
                <div class="current-time" id="currentTime">16:45:30 ‚Ä¢ 16 –∏—é–ª—è 2025</div>
            </div>
            <div class="user-info">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>admin</strong><br>
                –°—Ç–∞—Ç—É—Å: <span style="color: #27ae60;">‚óè –û–Ω–ª–∞–π–Ω</span>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã -->
        <div class="controls">
            <div>
                <button class="btn btn-secondary" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                <button class="btn btn-secondary" onclick="previousApartment()">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                <button class="btn btn-secondary" onclick="nextApartment()">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
            </div>
            <div>
                <span style="color: white;">–ö–∞–º–µ—Ä –≤ —Å–µ—Ç–∏: <span id="onlineCameras">0</span> / <span id="totalCameras">0</span></span>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä -->
        <div class="apartment-buttons" id="apartmentButtons">
            <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –°–µ—Ç–∫–∞ –∫–∞–º–µ—Ä -->
        <div class="camera-grid" id="cameraGrid">
            <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –∞–≤—Ç–æ—Ü–∏–∫–ª–∞ -->
        <div class="autocycle-controls">
            <label>–ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:</label>
            <select id="cycleInterval" onchange="updateCycleInterval()">
                <option value="5">–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫</option>
                <option value="10">–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫</option>
                <option value="15" selected>–∫–∞–∂–¥—ã–µ 15 —Å–µ–∫</option>
                <option value="30">–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫</option>
                <option value="60">–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É</option>
            </select>
            <span id="cycleStatus">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
        </div>

        <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º -->
        <div class="fullscreen-overlay" id="fullscreenOverlay">
            <div class="fullscreen-video">
                <button class="fullscreen-close" onclick="closeFullscreen()">√ó</button>
                <video id="fullscreenVideo" controls></video>
                <div class="fullscreen-info" id="fullscreenInfo">
                    <div id="fullscreenCameraName" style="font-size: 18px; font-weight: bold;"></div>
                    <div id="fullscreenCameraStatus" style="font-size: 14px; color: #bdc3c7; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let apartments = [];
        let cameras = [];
        let currentApartmentIndex = 0;
        let cycleInterval = 15;
        let cycleTimer = null;
        let isPaused = false;
        let activeStreams = new Map();
        let hlsInstances = new Map();
        let currentAudioCamera = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initializeSystem() {
            try {
                await loadApartments();
                await loadCameras();
                renderApartmentButtons();
                showCurrentApartment();
                startCycle();
                updateTime();
                setInterval(updateTime, 1000);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä
        async function loadApartments() {
            try {
                const response = await fetch('/api/apartments');
                apartments = await response.json();
                console.log('‚úÖ –ö–≤–∞—Ä—Ç–∏—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', apartments.length);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä
        async function loadCameras() {
            try {
                const response = await fetch('/api/cameras');
                cameras = await response.json();
                console.log('‚úÖ –ö–∞–º–µ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', cameras.length);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä:', error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫ –∫–≤–∞—Ä—Ç–∏—Ä
        function renderApartmentButtons() {
            const buttonsContainer = document.getElementById('apartmentButtons');
            buttonsContainer.innerHTML = '';

            apartments.forEach((apartment, index) => {
                const btn = document.createElement('div');
                btn.className = `apartment-btn ${index === currentApartmentIndex ? 'active' : ''}`;
                btn.textContent = apartment.apartment_number;
                btn.onclick = () => switchToApartment(index);
                buttonsContainer.appendChild(btn);
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É
        async function showCurrentApartment() {
            if (apartments.length === 0) return;

            const apartment = apartments[currentApartmentIndex];
            const apartmentCameras = cameras.filter(c => c.apartment_name === apartment.apartment_name);

            // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('currentApartment').textContent = 
                `${apartment.apartment_name} (–∫–≤–∞—Ä—Ç–∏—Ä–∞ ${apartment.apartment_number})`;

            // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('totalCameras').textContent = apartmentCameras.length;

            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ—Ç–æ–∫–∏
            await stopAllStreams();

            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—ã
            renderCameras(apartmentCameras);

            // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä
            document.querySelectorAll('.apartment-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === currentApartmentIndex);
            });

            // –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –∫–∞–º–µ—Ä
            await startStreamsForCameras(apartmentCameras);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–º–µ—Ä
        function renderCameras(apartmentCameras) {
            const grid = document.getElementById('cameraGrid');
            grid.innerHTML = '';
            grid.className = `camera-grid cameras-${apartmentCameras.length}`;

            apartmentCameras.forEach(camera => {
                const cameraSlot = document.createElement('div');
                cameraSlot.className = 'camera-slot loading';
                cameraSlot.innerHTML = `
                    <video class="camera-video" id="video-${camera.id}" muted playsinline></video>
                    <div class="camera-placeholder" id="placeholder-${camera.id}">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="camera-overlay">
                        <div class="camera-name">${camera.camera_name}</div>
                        <div class="camera-status" id="status-${camera.id}">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                    </div>
                    <button class="audio-btn" id="audio-${camera.id}" onclick="toggleAudio(${camera.id})">üîá</button>
                    <div class="status-indicator loading" id="indicator-${camera.id}"></div>
                `;
                
                cameraSlot.onclick = () => openFullscreen(camera.id);
                grid.appendChild(cameraSlot);
            });
        }

        // –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∫–∞–º–µ—Ä
        async function startStreamsForCameras(cameras) {
            let onlineCount = 0;
            
            for (const camera of cameras) {
                try {
                    const success = await startStream(camera.id, '480p');
                    if (success) onlineCount++;
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –∫–∞–º–µ—Ä—ã ${camera.id}:`, error);
                }
            }
            
            document.getElementById('onlineCameras').textContent = onlineCount;
        }

        // –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞
        async function startStream(cameraId, quality = '480p') {
            const camera = cameras.find(c => c.id === cameraId);
            if (!camera) return false;

            const statusEl = document.getElementById(`status-${cameraId}`);
            const indicatorEl = document.getElementById(`indicator-${cameraId}`);
            const slotEl = document.querySelector(`#video-${cameraId}`).closest('.camera-slot');
            
            console.log(`üé¨ –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞: ${camera.camera_name} (${quality})`);
            
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cameraId: cameraId,
                        rtspUrl: camera.rtsp_link,
                        quality: quality
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ –ü–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω: ${result.streamId}`);
                    
                    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ç–æ–∫–µ
                    activeStreams.set(cameraId, {
                        streamId: result.streamId,
                        quality: quality,
                        camera: camera
                    });
                    
                    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HLS –ø–ª–µ–µ—Ä
                    const streamUrl = `/stream/${result.streamId}/playlist.m3u8`;
                    setupHLSPlayer(cameraId, streamUrl);
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å UI
                    statusEl.textContent = `${quality} ‚Ä¢ –û–Ω–ª–∞–π–Ω`;
                    indicatorEl.className = 'status-indicator online';
                    slotEl.classList.remove('loading', 'error');
                    slotEl.classList.add('active');
                    
                    return true;
                } else {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞ ${cameraId}:`, error);
                
                // –û–±–Ω–æ–≤–∏—Ç—å UI –ø—Ä–∏ –æ—à–∏–±–∫–µ
                statusEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                indicatorEl.className = 'status-indicator offline';
                slotEl.classList.remove('loading', 'active');
                slotEl.classList.add('error');
                
                return false;
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HLS –ø–ª–µ–µ—Ä–∞
        function setupHLSPlayer(cameraId, streamUrl) {
            const video = document.getElementById(`video-${cameraId}`);
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            
            if (Hls.isSupported()) {
                const hls = new Hls({
                    liveSyncDurationCount: 1,
                    liveMaxLatencyDurationCount: 2,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 10,
                    maxBufferLength: 20
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                hlsInstances.set(cameraId, hls);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log(`‚úÖ HLS –º–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –∫–∞–º–µ—Ä—ã ${cameraId}`);
                    placeholder.style.display = 'none';
                    video.style.display = 'block';
                    video.play().catch(e => console.warn('–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'));
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error(`‚ùå HLS –æ—à–∏–±–∫–∞ –¥–ª—è –∫–∞–º–µ—Ä—ã ${cameraId}:`, data);
                    if (data.fatal) {
                        placeholder.style.display = 'flex';
                        placeholder.innerHTML = '‚ùå<br>–û—à–∏–±–∫–∞';
                        video.style.display = 'none';
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // –ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HLS (Safari)
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    placeholder.style.display = 'none';
                    video.style.display = 'block';
                    video.play().catch(console.warn);
                });
            } else {
                console.error('‚ùå HLS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                placeholder.innerHTML = '‚ùå<br>–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
        async function stopAllStreams() {
            for (const [cameraId, streamData] of activeStreams) {
                await stopStream(cameraId);
            }
            activeStreams.clear();
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞
        async function stopStream(cameraId) {
            const streamData = activeStreams.get(cameraId);
            if (!streamData) return;

            console.log(`üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –∫–∞–º–µ—Ä—ã ${cameraId}`);

            try {
                const response = await fetch('/api/stream/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamId: streamData.streamId })
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`‚úÖ –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${streamData.streamId}`);
                }
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞ ${cameraId}:`, error);
            }

            // –û—á–∏—Å—Ç–∫–∞ HLS –ø–ª–µ–µ—Ä–∞
            if (hlsInstances.has(cameraId)) {
                hlsInstances.get(cameraId).destroy();
                hlsInstances.delete(cameraId);
            }

            // –û—á–∏—Å—Ç–∫–∞ –≤–∏–¥–µ–æ
            const video = document.getElementById(`video-${cameraId}`);
            if (video) {
                video.src = '';
                video.style.display = 'none';
            }

            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            if (placeholder) {
                placeholder.style.display = 'flex';
                placeholder.innerHTML = 'üìπ';
            }

            activeStreams.delete(cameraId);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä
        function switchToApartment(index) {
            if (index !== currentApartmentIndex) {
                currentApartmentIndex = index;
                showCurrentApartment();
            }
        }

        function previousApartment() {
            currentApartmentIndex = (currentApartmentIndex - 1 + apartments.length) % apartments.length;
            showCurrentApartment();
        }

        function nextApartment() {
            currentApartmentIndex = (currentApartmentIndex + 1) % apartments.length;
            showCurrentApartment();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–º
        function startCycle() {
            if (isPaused) return;
            
            cycleTimer = setInterval(() => {
                if (!isPaused) {
                    nextApartment();
                }
            }, cycleInterval * 1000);
            
            document.getElementById('cycleStatus').textContent = 
                `–ê–∫—Ç–∏–≤–Ω–æ (${cycleInterval}—Å)`;
        }

        function stopCycle() {
            if (cycleTimer) {
                clearInterval(cycleTimer);
                cycleTimer = null;
            }
            document.getElementById('cycleStatus').textContent = '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                stopCycle();
                btn.textContent = '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            } else {
                startCycle();
                btn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
            }
        }

        function updateCycleInterval() {
            cycleInterval = parseInt(document.getElementById('cycleInterval').value);
            if (!isPaused) {
                stopCycle();
                startCycle();
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º
        function toggleAudio(cameraId) {
            const audioBtn = document.getElementById(`audio-${cameraId}`);
            const video = document.getElementById(`video-${cameraId}`);
            
            if (currentAudioCamera === cameraId) {
                // –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫
                video.muted = true;
                audioBtn.textContent = 'üîá';
                audioBtn.classList.remove('active');
                currentAudioCamera = null;
            } else {
                // –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–∞–º–µ—Ä–µ
                if (currentAudioCamera) {
                    const prevVideo = document.getElementById(`video-${currentAudioCamera}`);
                    const prevBtn = document.getElementById(`audio-${currentAudioCamera}`);
                    if (prevVideo) prevVideo.muted = true;
                    if (prevBtn) {
                        prevBtn.textContent = 'üîá';
                        prevBtn.classList.remove('active');
                    }
                }
                
                // –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ –Ω–∞ —Ç–µ–∫—É—â–µ–π –∫–∞–º–µ—Ä–µ
                video.muted = false;
                audioBtn.textContent = 'üîä';
                audioBtn.classList.add('active');
                currentAudioCamera = cameraId;
            }
        }

        // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        async function openFullscreen(cameraId) {
            const camera = cameras.find(c => c.id === cameraId);
            if (!camera) return;

            const overlay = document.getElementById('fullscreenOverlay');
            const video = document.getElementById('fullscreenVideo');
            const nameEl = document.getElementById('fullscreenCameraName');
            const statusEl = document.getElementById('fullscreenCameraStatus');

            // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            nameEl.textContent = camera.camera_name;
            statusEl.textContent = '1080p ‚Ä¢ HD –∫–∞—á–µ—Å—Ç–≤–æ';

            // –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫ –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cameraId: cameraId,
                        rtspUrl: camera.rtsp_link,
                        quality: '1080p'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    const streamUrl = `/stream/${result.streamId}/playlist.m3u8`;
                    
                    if (Hls.isSupported()) {
                        const hls = new Hls({
                            liveSyncDurationCount: 1,
                            liveMaxLatencyDurationCount: 2,
                            enableWorker: true,
                            lowLatencyMode: true
                        });
                        
                        hls.loadSource(streamUrl);
                        hls.attachMedia(video);
                        
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            video.play().catch(console.warn);
                        });
                        
                        video.fullscreenHls = hls;
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = streamUrl;
                        video.play().catch(console.warn);
                    }
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞:', error);
                statusEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }

            overlay.classList.add('active');
        }

        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            const video = document.getElementById('fullscreenVideo');
            
            // –û—á–∏—Å—Ç–∏—Ç—å HLS –ø–ª–µ–µ—Ä
            if (video.fullscreenHls) {
                video.fullscreenHls.destroy();
                video.fullscreenHls = null;
            }
            
            video.src = '';
            overlay.classList.remove('active');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU');
            const dateString = now.toLocaleDateString('ru-RU');
            document.getElementById('currentTime').textContent = `${timeString} ‚Ä¢ ${dateString}`;
        }

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                    previousApartment();
                    break;
                case 'ArrowRight':
                    nextApartment();
                    break;
                case ' ':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'Escape':
                    closeFullscreen();
                    break;
            }
        });

        // –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
        initializeSystem();
    </script>
</body>
</html>
