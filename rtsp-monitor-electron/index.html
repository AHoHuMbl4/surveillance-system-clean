<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Циклический мониторинг • Система видеонаблюдения</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Шапка */
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .current-info {
            color: white;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }

        .current-apartment {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .current-time {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
        }

        .user-info {
            color: white;
            text-align: right;
            font-size: 14px;
        }

        /* Контролы */
        .controls {
            background: rgba(0,0,0,0.2);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Кнопки квартир */
        .apartment-buttons {
            padding: 15px 30px;
            display: flex;
            gap: 10px;
            justify-content: center;
            background: rgba(0,0,0,0.1);
        }

        .apartment-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .apartment-btn.active {
            background: #3498db;
            border-color: #3498db;
        }

        .apartment-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Сетка камер */
        .camera-grid {
            flex: 1;
            padding: 20px 30px;
            display: grid;
            gap: 15px;
            align-content: center;
        }

        /* Адаптивная сетка */
        .camera-grid.cameras-1 { grid-template-columns: 1fr; max-width: 800px; margin: 0 auto; }
        .camera-grid.cameras-2 { grid-template-columns: 1fr 1fr; }
        .camera-grid.cameras-3 { grid-template-columns: 1fr 1fr 1fr; }
        .camera-grid.cameras-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .camera-grid.cameras-5, .camera-grid.cameras-6 { grid-template-columns: repeat(3, 1fr); }
        .camera-grid.cameras-7, .camera-grid.cameras-8, .camera-grid.cameras-9 { grid-template-columns: repeat(3, 1fr); }
        .camera-grid.cameras-10, .camera-grid.cameras-11, .camera-grid.cameras-12 { grid-template-columns: repeat(4, 1fr); }
        .camera-grid.cameras-13, .camera-grid.cameras-14, .camera-grid.cameras-15, .camera-grid.cameras-16 { grid-template-columns: repeat(4, 1fr); }

        /* Слот камеры */
        .camera-slot {
            position: relative;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .camera-slot:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .camera-slot.active {
            border-color: #27ae60;
        }

        .camera-slot.error {
            border-color: #e74c3c;
        }

        .camera-slot.loading {
            border-color: #f39c12;
        }

        /* Видео в слоте */
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .camera-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.6);
        }

        .camera-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .camera-slot:hover .camera-overlay {
            transform: translateY(0);
        }

        .camera-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .camera-status {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        /* Кнопка звука */
        .audio-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .audio-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        .audio-btn.active {
            background: #27ae60;
        }

        /* Индикатор статуса */
        .status-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #95a5a6;
        }

        .status-indicator.online {
            background: #27ae60;
        }

        .status-indicator.offline {
            background: #e74c3c;
        }

        .status-indicator.loading {
            background: #f39c12;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Контролы автоцикла */
        .autocycle-controls {
            background: rgba(0,0,0,0.2);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: white;
            font-size: 14px;
        }

        .autocycle-controls select {
            padding: 5px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
        }

        .autocycle-controls select option {
            background: #333;
            color: white;
        }

        /* Полноэкранный режим */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-video {
            position: relative;
            width: 90%;
            height: 90%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .fullscreen-video video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .fullscreen-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка -->
        <div class="header">
            <div class="logo">🎥 Система видеонаблюдения</div>
            <div class="current-info">
                <div class="current-apartment" id="currentApartment">Тайланд (квартира 91)</div>
                <div class="current-time" id="currentTime">16:45:30 • 16 июля 2025</div>
            </div>
            <div class="user-info">
                Пользователь: <strong>admin</strong><br>
                Статус: <span style="color: #27ae60;">● Онлайн</span>
            </div>
        </div>

        <!-- Контролы -->
        <div class="controls">
            <div>
                <button class="btn btn-secondary" id="pauseBtn" onclick="togglePause()">⏸️ Пауза</button>
                <button class="btn btn-secondary" onclick="previousApartment()">← Предыдущая</button>
                <button class="btn btn-secondary" onclick="nextApartment()">Следующая →</button>
            </div>
            <div>
                <span style="color: white;">Камер в сети: <span id="onlineCameras">0</span> / <span id="totalCameras">0</span></span>
            </div>
        </div>

        <!-- Кнопки квартир -->
        <div class="apartment-buttons" id="apartmentButtons">
            <!-- Генерируются динамически -->
        </div>

        <!-- Сетка камер -->
        <div class="camera-grid" id="cameraGrid">
            <!-- Генерируются динамически -->
        </div>

        <!-- Контролы автоцикла -->
        <div class="autocycle-controls">
            <label>Автопереключение:</label>
            <select id="cycleInterval" onchange="updateCycleInterval()">
                <option value="5">каждые 5 сек</option>
                <option value="10">каждые 10 сек</option>
                <option value="15" selected>каждые 15 сек</option>
                <option value="30">каждые 30 сек</option>
                <option value="60">каждую минуту</option>
            </select>
            <span id="cycleStatus">Приостановлено</span>
        </div>

        <!-- Полноэкранный режим -->
        <div class="fullscreen-overlay" id="fullscreenOverlay">
            <div class="fullscreen-video">
                <button class="fullscreen-close" onclick="closeFullscreen()">×</button>
                <video id="fullscreenVideo" controls></video>
                <div class="fullscreen-info" id="fullscreenInfo">
                    <div id="fullscreenCameraName" style="font-size: 18px; font-weight: bold;"></div>
                    <div id="fullscreenCameraStatus" style="font-size: 14px; color: #bdc3c7; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 Интегрированная система видеонаблюдения загружена');

        // Глобальные переменные
        let apartments = [];
        let cameras = [];
        let currentApartmentIndex = 0;
        let cycleInterval = 15;
        let cycleTimer = null;
        let isPaused = false;
        let activeStreams = new Map();
        let hlsInstances = new Map();
        let currentAudioCamera = null;

        // Инициализация
        async function initializeSystem() {
            try {
                await loadApartments();
                await loadCameras();
                renderApartmentButtons();
                showCurrentApartment();
                startCycle();
                updateTime();
                setInterval(updateTime, 1000);
            } catch (error) {
                console.error('❌ Ошибка инициализации:', error);
            }
        }

        // Загрузка квартир
        async function loadApartments() {
            try {
                const response = await fetch('/api/apartments');
                apartments = await response.json();
                console.log('✅ Квартиры загружены:', apartments.length);
            } catch (error) {
                console.error('❌ Ошибка загрузки квартир:', error);
            }
        }

        // Загрузка камер
        async function loadCameras() {
            try {
                const response = await fetch('/api/cameras');
                cameras = await response.json();
                console.log('✅ Камеры загружены:', cameras.length);
            } catch (error) {
                console.error('❌ Ошибка загрузки камер:', error);
            }
        }

        // Отрисовка кнопок квартир
        function renderApartmentButtons() {
            const buttonsContainer = document.getElementById('apartmentButtons');
            buttonsContainer.innerHTML = '';

            apartments.forEach((apartment, index) => {
                const btn = document.createElement('div');
                btn.className = `apartment-btn ${index === currentApartmentIndex ? 'active' : ''}`;
                btn.textContent = apartment.apartment_number;
                btn.onclick = () => switchToApartment(index);
                buttonsContainer.appendChild(btn);
            });
        }

        // Показать текущую квартиру
        async function showCurrentApartment() {
            if (apartments.length === 0) return;

            const apartment = apartments[currentApartmentIndex];
            const apartmentCameras = cameras.filter(c => c.apartment_name === apartment.apartment_name);

            // Обновить заголовок
            document.getElementById('currentApartment').textContent = 
                `${apartment.apartment_name} (квартира ${apartment.apartment_number})`;

            // Обновить счетчики
            document.getElementById('totalCameras').textContent = apartmentCameras.length;

            // Остановить предыдущие потоки
            await stopAllStreams();

            // Отрисовать камеры
            renderCameras(apartmentCameras);

            // Обновить кнопки квартир
            document.querySelectorAll('.apartment-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === currentApartmentIndex);
            });

            // Запустить потоки для текущих камер
            await startStreamsForCameras(apartmentCameras);
        }

        // Отрисовка камер
        function renderCameras(apartmentCameras) {
            const grid = document.getElementById('cameraGrid');
            grid.innerHTML = '';
            grid.className = `camera-grid cameras-${apartmentCameras.length}`;

            apartmentCameras.forEach(camera => {
                const cameraSlot = document.createElement('div');
                cameraSlot.className = 'camera-slot loading';
                cameraSlot.innerHTML = `
                    <video class="camera-video" id="video-${camera.id}" muted playsinline></video>
                    <div class="camera-placeholder" id="placeholder-${camera.id}">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="camera-overlay">
                        <div class="camera-name">${camera.camera_name}</div>
                        <div class="camera-status" id="status-${camera.id}">Подключение...</div>
                    </div>
                    <button class="audio-btn" id="audio-${camera.id}" onclick="toggleAudio(${camera.id})">🔇</button>
                    <div class="status-indicator loading" id="indicator-${camera.id}"></div>
                `;
                
                cameraSlot.onclick = () => openFullscreen(camera.id);
                grid.appendChild(cameraSlot);
            });
        }

        // Запуск потоков для камер
        async function startStreamsForCameras(cameras) {
            let onlineCount = 0;
            
            for (const camera of cameras) {
                try {
                    const success = await startStream(camera.id, '480p');
                    if (success) onlineCount++;
                } catch (error) {
                    console.error(`❌ Ошибка запуска потока для камеры ${camera.id}:`, error);
                }
            }
            
            document.getElementById('onlineCameras').textContent = onlineCount;
        }

        // Запуск потока
        async function startStream(cameraId, quality = '480p') {
            const camera = cameras.find(c => c.id === cameraId);
            if (!camera) return false;

            const statusEl = document.getElementById(`status-${cameraId}`);
            const indicatorEl = document.getElementById(`indicator-${cameraId}`);
            const slotEl = document.querySelector(`#video-${cameraId}`).closest('.camera-slot');
            
            console.log(`🎬 Запуск потока: ${camera.camera_name} (${quality})`);
            
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cameraId: cameraId,
                        rtspUrl: camera.rtsp_link,
                        quality: quality
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log(`✅ Поток запущен: ${result.streamId}`);
                    
                    // Сохранить информацию о потоке
                    activeStreams.set(cameraId, {
                        streamId: result.streamId,
                        quality: quality,
                        camera: camera
                    });
                    
                    // Настроить HLS плеер
                    const streamUrl = `/stream/${result.streamId}/playlist.m3u8`;
                    setupHLSPlayer(cameraId, streamUrl);
                    
                    // Обновить UI
                    statusEl.textContent = `${quality} • Онлайн`;
                    indicatorEl.className = 'status-indicator online';
                    slotEl.classList.remove('loading', 'error');
                    slotEl.classList.add('active');
                    
                    return true;
                } else {
                    throw new Error(result.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                console.error(`❌ Ошибка запуска потока ${cameraId}:`, error);
                
                // Обновить UI при ошибке
                statusEl.textContent = 'Ошибка подключения';
                indicatorEl.className = 'status-indicator offline';
                slotEl.classList.remove('loading', 'active');
                slotEl.classList.add('error');
                
                return false;
            }
        }

        // Настройка HLS плеера
        function setupHLSPlayer(cameraId, streamUrl) {
            const video = document.getElementById(`video-${cameraId}`);
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            
            if (Hls.isSupported()) {
                const hls = new Hls({
                    liveSyncDurationCount: 1,
                    liveMaxLatencyDurationCount: 2,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 10,
                    maxBufferLength: 20
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                hlsInstances.set(cameraId, hls);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log(`✅ HLS манифест загружен для камеры ${cameraId}`);
                    placeholder.style.display = 'none';
                    video.style.display = 'block';
                    video.play().catch(e => console.warn('Автозапуск заблокирован'));
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error(`❌ HLS ошибка для камеры ${cameraId}:`, data);
                    if (data.fatal) {
                        placeholder.style.display = 'flex';
                        placeholder.innerHTML = '❌<br>Ошибка';
                        video.style.display = 'none';
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Нативная поддержка HLS (Safari)
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    placeholder.style.display = 'none';
                    video.style.display = 'block';
                    video.play().catch(console.warn);
                });
            } else {
                console.error('❌ HLS не поддерживается в этом браузере');
                placeholder.innerHTML = '❌<br>Не поддерживается';
            }
        }

        // Остановка всех потоков
        async function stopAllStreams() {
            for (const [cameraId, streamData] of activeStreams) {
                await stopStream(cameraId);
            }
            activeStreams.clear();
        }

        // Остановка потока
        async function stopStream(cameraId) {
            const streamData = activeStreams.get(cameraId);
            if (!streamData) return;

            console.log(`🛑 Остановка потока камеры ${cameraId}`);

            try {
                const response = await fetch('/api/stream/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamId: streamData.streamId })
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`✅ Поток остановлен: ${streamData.streamId}`);
                }
            } catch (error) {
                console.error(`❌ Ошибка остановки потока ${cameraId}:`, error);
            }

            // Очистка HLS плеера
            if (hlsInstances.has(cameraId)) {
                hlsInstances.get(cameraId).destroy();
                hlsInstances.delete(cameraId);
            }

            // Очистка видео
            const video = document.getElementById(`video-${cameraId}`);
            if (video) {
                video.src = '';
                video.style.display = 'none';
            }

            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            if (placeholder) {
                placeholder.style.display = 'flex';
                placeholder.innerHTML = '📹';
            }

            activeStreams.delete(cameraId);
        }

        // Переключение квартир
        function switchToApartment(index) {
            if (index !== currentApartmentIndex) {
                currentApartmentIndex = index;
                showCurrentApartment();
            }
        }

        function previousApartment() {
            currentApartmentIndex = (currentApartmentIndex - 1 + apartments.length) % apartments.length;
            showCurrentApartment();
        }

        function nextApartment() {
            currentApartmentIndex = (currentApartmentIndex + 1) % apartments.length;
            showCurrentApartment();
        }

        // Управление циклом
        function startCycle() {
            if (isPaused) return;
            
            cycleTimer = setInterval(() => {
                if (!isPaused) {
                    nextApartment();
                }
            }, cycleInterval * 1000);
            
            document.getElementById('cycleStatus').textContent = 
                `Активно (${cycleInterval}с)`;
        }

        function stopCycle() {
            if (cycleTimer) {
                clearInterval(cycleTimer);
                cycleTimer = null;
            }
            document.getElementById('cycleStatus').textContent = 'Приостановлено';
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                stopCycle();
                btn.textContent = '▶️ Продолжить';
            } else {
                startCycle();
                btn.textContent = '⏸️ Пауза';
            }
        }

        function updateCycleInterval() {
            cycleInterval = parseInt(document.getElementById('cycleInterval').value);
            if (!isPaused) {
                stopCycle();
                startCycle();
            }
        }

        // Управление звуком
        function toggleAudio(cameraId) {
            const audioBtn = document.getElementById(`audio-${cameraId}`);
            const video = document.getElementById(`video-${cameraId}`);
            
            if (currentAudioCamera === cameraId) {
                // Выключить звук
                video.muted = true;
                audioBtn.textContent = '🔇';
                audioBtn.classList.remove('active');
                currentAudioCamera = null;
            } else {
                // Выключить звук на предыдущей камере
                if (currentAudioCamera) {
                    const prevVideo = document.getElementById(`video-${currentAudioCamera}`);
                    const prevBtn = document.getElementById(`audio-${currentAudioCamera}`);
                    if (prevVideo) prevVideo.muted = true;
                    if (prevBtn) {
                        prevBtn.textContent = '🔇';
                        prevBtn.classList.remove('active');
                    }
                }
                
                // Включить звук на текущей камере
                video.muted = false;
                audioBtn.textContent = '🔊';
                audioBtn.classList.add('active');
                currentAudioCamera = cameraId;
            }
        }

        // Полноэкранный режим
        async function openFullscreen(cameraId) {
            const camera = cameras.find(c => c.id === cameraId);
            if (!camera) return;

            const overlay = document.getElementById('fullscreenOverlay');
            const video = document.getElementById('fullscreenVideo');
            const nameEl = document.getElementById('fullscreenCameraName');
            const statusEl = document.getElementById('fullscreenCameraStatus');

            // Обновить информацию
            nameEl.textContent = camera.camera_name;
            statusEl.textContent = '1080p • HD качество';

            // Запустить поток в высоком качестве
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cameraId: cameraId,
                        rtspUrl: camera.rtsp_link,
                        quality: '1080p'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    const streamUrl = `/stream/${result.streamId}/playlist.m3u8`;
                    
                    if (Hls.isSupported()) {
                        const hls = new Hls({
                            liveSyncDurationCount: 1,
                            liveMaxLatencyDurationCount: 2,
                            enableWorker: true,
                            lowLatencyMode: true
                        });
                        
                        hls.loadSource(streamUrl);
                        hls.attachMedia(video);
                        
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            video.play().catch(console.warn);
                        });
                        
                        video.fullscreenHls = hls;
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = streamUrl;
                        video.play().catch(console.warn);
                    }
                }
            } catch (error) {
                console.error('❌ Ошибка запуска полноэкранного потока:', error);
                statusEl.textContent = 'Ошибка подключения';
            }

            overlay.classList.add('active');
        }

        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            const video = document.getElementById('fullscreenVideo');
            
            // Очистить HLS плеер
            if (video.fullscreenHls) {
                video.fullscreenHls.destroy();
                video.fullscreenHls = null;
            }
            
            video.src = '';
            overlay.classList.remove('active');
        }

        // Обновление времени
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU');
            const dateString = now.toLocaleDateString('ru-RU');
            document.getElementById('currentTime').textContent = `${timeString} • ${dateString}`;
        }

        // Горячие клавиши
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                    previousApartment();
                    break;
                case 'ArrowRight':
                    nextApartment();
                    break;
                case ' ':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'Escape':
                    closeFullscreen();
                    break;
            }
        });

        // Запуск системы
        initializeSystem();
    </script>
</body>
</html>
