<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RTSP Monitor - –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; padding: 20px; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: #2c3e50; border-radius: 10px; }
        .status { background: #27ae60; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0; }
        .camera { background: #2c3e50; padding: 20px; border-radius: 10px; border: 2px solid #34495e; }
        .camera-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #3498db; }
        .camera-info { font-size: 14px; color: #bdc3c7; margin-bottom: 15px; }
        .video-container { height: 300px; background: #34495e; border-radius: 8px; margin: 15px 0; position: relative; }
        .camera-video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #bdc3c7; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        .btn:hover { background: #2980b9; }
        .btn.stop { background: #e74c3c; }
        .btn.stop:hover { background: #c0392b; }
        .status-text { font-size: 12px; color: #bdc3c7; text-align: center; }
        .loading { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .back-link { display: inline-block; margin-bottom: 20px; padding: 10px 20px; background: #34495e; color: white; text-decoration: none; border-radius: 5px; }
        .back-link:hover { background: #2c3e50; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</a>
            <h1>üé• RTSP Monitor - –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h1>
            <div class="status">
                üî¨ –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π MJPEG –¥–µ–∫–æ–¥–µ—Ä ‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∏–∑–º–µ–Ω–µ–Ω
            </div>
        </div>

        <div class="grid" id="cameras">
            <!-- –ö–∞–º–µ—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <script>
        let cameras = [];
        let activeStreams = new Map();

        async function loadCameras() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä...');
                const response = await fetch('/api/cameras');
                cameras = await response.json();
                console.log('‚úÖ –ö–∞–º–µ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', cameras);
                renderCameras();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä:', error);
            }
        }

        function renderCameras() {
            const container = document.getElementById('cameras');
            container.innerHTML = '';

            cameras.forEach(camera => {
                const cameraDiv = document.createElement('div');
                cameraDiv.className = 'camera';
                cameraDiv.innerHTML = `
                    <div class="camera-title">${camera.camera_name}</div>
                    <div class="camera-info">–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${camera.apartment_name}</div>
                    <div class="video-container">
                        <img class="camera-video" id="video-${camera.id}" style="display: none;" />
                        <div class="placeholder" id="placeholder-${camera.id}">
                            <div style="font-size: 3em; margin-bottom: 10px;">üìπ</div>
                            <div>–¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ RTSP –¥–µ–∫–æ–¥–µ—Ä–∞</div>
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">–ü—Ä—è–º–æ–π MJPEG –±–µ–∑ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ</div>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn" onclick="startStream(${camera.id}, 'sub')">üì∫ –¢–µ—Å—Ç 480p</button>
                        <button class="btn" onclick="startStream(${camera.id}, 'main')">üñ•Ô∏è –¢–µ—Å—Ç 1080p</button>
                        <button class="btn stop" onclick="stopStream(${camera.id})">‚èπÔ∏è –°—Ç–æ–ø</button>
                    </div>
                    <div class="status-text" id="status-${camera.id}">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</div>
                `;
                container.appendChild(cameraDiv);
            });

            console.log(`‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${cameras.length} –∫–∞–º–µ—Ä`);
        }

        async function startStream(cameraId, quality) {
            const camera = cameras.find(c => c.id === cameraId);
            if (!camera) {
                console.error('‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', cameraId);
                return;
            }

            console.log(`üì° –¢–ï–°–¢: –ó–∞–ø—É—Å–∫ RTSP –ø–æ—Ç–æ–∫–∞: ${camera.camera_name} (${quality})`);
            
            const placeholder = document.getElementById(`placeholder-${cameraId}`);
            const status = document.getElementById(`status-${cameraId}`);
            
            if (placeholder) {
                placeholder.innerHTML = `
                    <div class="loading" style="font-size: 3em; margin-bottom: 10px;">‚è≥</div>
                    <div>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
                    <div style="font-size: 12px; margin-top: 5px;">${camera.camera_name}</div>
                `;
            }
            
            if (status) {
                status.textContent = `–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è... (${quality})`;
            }
            
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        cameraId, 
                        rtspUrl: quality === 'main' ? camera.rtsp_main : camera.rtsp_sub,
                        quality 
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ –¢–ï–°–¢: –ü–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω: ${result.streamId}`);
                    console.log(`üåê –¢–ï–°–¢: URL: ${result.url}`);
                    
                    const video = document.getElementById(`video-${cameraId}`);
                    
                    if (video && placeholder && status) {
                        setTimeout(() => {
                            video.src = result.url;
                            video.style.display = 'block';
                            placeholder.style.display = 'none';
                            status.textContent = `‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω (${quality}) - MJPEG –∞–∫—Ç–∏–≤–µ–Ω`;
                            
                            activeStreams.set(cameraId, result);
                            
                            console.log(`üé¨ –¢–ï–°–¢: –í–∏–¥–µ–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–º–µ—Ä—ã ${cameraId}`);
                        }, 1000);
                    }
                } else {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error(`‚ùå –¢–ï–°–¢: –û—à–∏–±–∫–∞:`, error);
                
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div style="font-size: 3em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞</div>
                        <div style="font-size: 12px; margin-top: 5px; color: #e74c3c;">${error.message}</div>
                    `;
                }
                
                if (status) {
                    status.textContent = '–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω';
                }
            }
        }

        async function stopStream(cameraId) {
            const streamData = activeStreams.get(cameraId);
            if (!streamData) {
                console.warn(`‚ö†Ô∏è –¢–ï–°–¢: –ü–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã ${cameraId} –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω`);
                return;
            }

            console.log(`üõë –¢–ï–°–¢: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞: ${streamData.streamId}`);

            try {
                const response = await fetch('/api/stream/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamId: streamData.streamId })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ –¢–ï–°–¢: –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`);
                    
                    const video = document.getElementById(`video-${cameraId}`);
                    const placeholder = document.getElementById(`placeholder-${cameraId}`);
                    const status = document.getElementById(`status-${cameraId}`);
                    
                    if (video && placeholder && status) {
                        video.src = '';
                        video.style.display = 'none';
                        placeholder.style.display = 'block';
                        placeholder.innerHTML = `
                            <div style="font-size: 3em; margin-bottom: 10px;">üìπ</div>
                            <div>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω</div>
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">–ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç</div>
                        `;
                        status.textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É —Ç–µ—Å—Ç—É';
                        
                        activeStreams.delete(cameraId);
                    }
                }
            } catch (error) {
                console.error(`‚ùå –¢–ï–°–¢: –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:`, error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üî¨ RTSP Monitor - –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω');
            loadCameras();
        });
    </script>
</body>
</html>
EOF

# 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
cat > test-server-update.js << 'EOF'
// –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const fs = require('fs');
const path = require('path');

// –î–æ–±–∞–≤–ª—è–µ–º –≤ handleRequest —Ñ—É–Ω–∫—Ü–∏—é:
if (pathname === '/test') {
    const testPath = path.join(__dirname, 'test-interface.html');
    if (fs.existsSync(testPath)) {
        const content = fs.readFileSync(testPath, 'utf8');
        res.setHeader('Content-Type', 'text/html; charset=utf-8');
        res.writeHead(200);
        res.end(content);
    } else {
        this.sendError(res, 404, 'Test interface not found');
    }
    return;
}
